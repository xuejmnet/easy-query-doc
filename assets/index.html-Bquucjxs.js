import{_ as e}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as n,b as i,d as t,a as l,o as r}from"./app-B2JUUH6N.js";const h={},p=["src"];function k(a,s){return r(),n("div",null,[s[0]||(s[0]=i('<h1 id="aggregate-root-save" tabindex="-1"><a class="header-anchor" href="#aggregate-root-save"><span>Aggregate Root Save</span></a></h1><p><code>eq</code> implemented aggregate root save mode after <code>3.1.24</code>, which can track changes to aggregate root objects and differential changes to corresponding value objects in <code>track</code> mode, enabling users to save complete object trees effortlessly.</p><p>What benefits does aggregate root save bring?</p><p>Use clean and tidy code in exchange for complex relational data saving</p><p><a href="https://github.com/xuejmnet/eq-doc" target="_blank" rel="noopener noreferrer">Click the link for the demo in this chapter</a> <a href="https://github.com/xuejmnet/eq-doc" target="_blank" rel="noopener noreferrer">https://github.com/xuejmnet/eq-doc</a></p><h2 id="aggregate-root-save-flow" tabindex="-1"><a class="header-anchor" href="#aggregate-root-save-flow"><span>Aggregate Root Save Flow</span></a></h2>',6)),t("img",{src:a.$withBase("/images/save-flow.png")},null,8,p),s[1]||(s[1]=i('<h2 id="concepts" tabindex="-1"><a class="header-anchor" href="#concepts"><span>Concepts</span></a></h2><p>Before starting with aggregate root save, we need to understand several concepts</p><h3 id="aggregate-root" tabindex="-1"><a class="header-anchor" href="#aggregate-root"><span>Aggregate Root</span></a></h3><p>If tables <code>a</code> and <code>b</code> use <code>a</code>&#39;s primary key to associate with <code>b</code>, then <code>a</code> is the aggregate root, and <code>b</code> is the value object.<br> In one sentence: using your own primary key as the association relationship means you are the aggregate root, and the target navigation is a value object or other.</p><h3 id="value-object" tabindex="-1"><a class="header-anchor" href="#value-object"><span>Value Object</span></a></h3><p>If tables <code>a</code> and <code>b</code> use <code>a</code>&#39;s primary key to associate with <code>b</code>, then <code>a</code> is the aggregate root, and <code>b</code> is the value object.<br> If the current object&#39;s association navigation targetProperty is the target table&#39;s primary key, then the current table is a value object of the target table.</p><p>There are two types of value objects:</p><ul><li>Cascade is null, this kind of value object will not continue to recursively traverse lower-level navigation properties, this kind of value object only has the share of updating association keys during aggregate root save, and will never have <code>insert</code> and <code>delete</code></li><li>Cascade delete, this kind of value object is a true value object, driven by the current aggregate root, and will traverse down navigation properties, with three states: <code>insert</code>, <code>update</code>, <code>delete</code></li></ul><h3 id="other-relationships" tabindex="-1"><a class="header-anchor" href="#other-relationships"><span>Other Relationships</span></a></h3><p>Associations between two tables using non-primary keys like other columns, or many-to-many without a mapping table, or path left-match, these we consider as other relationships</p><h2 id="cascade-dissociate-options" tabindex="-1"><a class="header-anchor" href="#cascade-dissociate-options"><span>Cascade Dissociate Options</span></a></h2><p>The <code>cascade</code> property of <code>@Navigate</code> has the following enumerations</p><table><thead><tr><th>Type</th><th>Function</th></tr></thead><tbody><tr><td>AUTO</td><td>When it comes to object dissociation operations, the system handles automatically, by default using <code>set null</code>, if it&#39;s a many-to-many operation on the mapping table, it cannot be determined and needs to be handled by the user themselves</td></tr><tr><td>NO_ACTION</td><td>Dissociation does no processing, user handles it themselves</td></tr><tr><td>SET_NULL</td><td>Dissociation processing sets targetProperty to null, does not delete the target record</td></tr><tr><td>DELETE</td><td>Dissociation processing deletes the target object, for example <code>user</code> and <code>user_role</code> and <code>role</code>, then <code>user_role</code> can be set to <code>delete</code></td></tr></tbody></table><h2 id="api-introduction" tabindex="-1"><a class="header-anchor" href="#api-introduction"><span>API Introduction</span></a></h2><table><thead><tr><th>API</th><th>Function</th></tr></thead><tbody><tr><td>configure</td><td>Configure options for the current save expression, such as not processing the root node, letting the user handle it themselves for concurrent judgment</td></tr><tr><td>savePath</td><td>Explicitly specify which object paths to save during saving</td></tr><tr><td>ignoreRoot</td><td>Ignore root node save, insert and update</td></tr><tr><td>removeRoot</td><td>Remove root node including removing remaining other include nodes</td></tr></tbody></table><h2 id="what-can-savable-bring" tabindex="-1"><a class="header-anchor" href="#what-can-savable-bring"><span>What can savable bring</span></a></h2><p>Before savable, when creating a many-to-many relationship, we needed to create user, user_role, role, and needed to assign values to user&#39;s id, then to role&#39;s id, then to user_role&#39;s userId and roleId. This is what needs to be considered for insertion.</p><p>If it&#39;s an update, we need to find which ones need to be added, which ones need to be deleted, and which ones need to be updated. Even if we&#39;re brutal, we can only delete all user_role and then re-insert them, but this would cause the user_role&#39;s id to change. If user_role is a mapping table with business fields, then this deletion-then-insertion method will no longer be applicable.</p><p>What can we do with save?</p><div class="language-java line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="java" style="--vp-collapsed-lines:30;--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> EasyEntityQuery</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> easyEntityQuery</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">PostMapping</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;/create&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">Transactional</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">rollbackFor</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> Exception</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">class</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    @</span><span style="--shiki-light:#A626A4;--shiki-dark:#E5C07B;">EasyQueryTrack</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Object</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> create</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">() {</span></span>\n<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        ArrayList</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">SysRole</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> sysRoles </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ArrayList</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        {</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">            SysRole</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> sysRole </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> SysRole</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            sysRole</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setName</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Administrator&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            sysRole</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setCreateTime</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">LocalDateTime</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">now</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            sysRoles</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">add</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(sysRole);</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        }</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        {</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">            SysRole</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> sysRole </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> SysRole</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            sysRole</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setName</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Guest&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            sysRole</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setCreateTime</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">LocalDateTime</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">now</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            sysRoles</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">add</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(sysRole);</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">        }</span></span>\n<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">        SysUser</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> sysUser </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> SysUser</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        sysUser</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setName</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;XiaoMing&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        sysUser</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setAge</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">18</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        sysUser</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setCreateTime</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">LocalDateTime</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">now</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        sysUser</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setSysRoleList</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(sysRoles);</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        easyEntityQuery</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">savable</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(sysRoles).</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">executeCommand</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>\n<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        easyEntityQuery</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">savable</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(sysUser).</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">executeCommand</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>\n<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;ok&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><p>We only need to create user and role, then save them respectively. Let&#39;s look at the generated SQL:</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> Preparing: </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">INSERT INTO</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> `t_role`</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">`id`</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">`name`</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">`create_time`</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">VALUES</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (?,?,?)</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> Parameters: 1a4c554e4b8b4cff81c87d9298b853ed(String),Administrator(String),</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">2025</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">09</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-11T22:</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">35</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">31</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">143878</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(LocalDateTime)</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> Preparing: </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">INSERT INTO</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> `t_role`</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">`id`</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">`name`</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">`create_time`</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">VALUES</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (?,?,?)</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> Parameters: bb9278911ecb4fe19c8a41a4e26a7c06(String),Guest(String),</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">2025</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">09</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-11T22:</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">35</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">31</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">143909</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(LocalDateTime)</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> Preparing: </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">INSERT INTO</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> `t_user`</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">`id`</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">`name`</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">`age`</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">`create_time`</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">VALUES</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (?,?,?,?)</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> Parameters: 2164d097983b4874859b01ef02f53340(String),XiaoMing(String),</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">18</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">Integer</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">),</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">2025</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">09</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-11T22:</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">35</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">31</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">143932</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(LocalDateTime)</span></span>\n<span class="line"></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> Preparing: </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">INSERT INTO</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> `t_user_role`</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">`id`</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">`user_id`</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">`role_id`</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">VALUES</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (?,?,?)</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> Parameters: b588a3ce9c72484fba366ce7288d8f5c(String),2164d097983b4874859b01ef02f53340(String),1a4c554e4b8b4cff81c87d9298b853ed(String)</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> Preparing: </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">INSERT INTO</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> `t_user_role`</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">`id`</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">`user_id`</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">`role_id`</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">VALUES</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (?,?,?)</span></span>\n<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> Parameters: 91b39127ba5d499f9cde6a326a49a71d(String),2164d097983b4874859b01ef02f53340(String),bb9278911ecb4fe19c8a41a4e26a7c06(String)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>',22)),l(` 

### Example One-to-Many
\`\`\`java
public class SysUser{
    @Column(primaryKey = true)
    private String id;
    private String name;

    /**
     * Number of bank cards owned by user
     */
    @Navigate(value = RelationTypeEnum.OneToMany, selfProperty = {"id"}, targetProperty = {"uid"},partitionOrder = PartitionOrderEnum.IGNORE)
    private List<SysBankCard> bankCards;

}
\`\`\`
\`SysUser\` and \`SysBankCard\` are one-to-many, and \`selfProperty = {"id"}\` is the primary key, so we consider \`SysBankCard\` to be a value object of \`SysUser\`. So if you construct \`SysBankCard\` when building \`SysUser\`, they will be added or modified together.

\`\`\`java

        SysUser sysUser = new SysUser();
        sysUser.setPhone("....");
        SysBankCard sysBankCard = new SysBankCard();
        sysBankCard.setCode("....");

        SysBank sysBank = new SysBank();
        sysBank.setName("....");
        sysBankCard.setBank(sysBank);

        sysUser.setBankCards(Arrays.asList(sysBankCard));

        //This writing will error because SysBankCard has an aggregate root, then it will assign the association property bankId of this aggregate root, but because it's initialized, sysBank doesn't have an id yet and will error
//        easyEntityQuery.savable(sysUser).executeCommand();

        try(Transaction transaction = easyEntityQuery.beginTransaction()){
            easyEntityQuery.savable(sysBank).executeCommand();
            easyEntityQuery.savable(sysUser).executeCommand();
            transaction.commit();
        }
\`\`\`
We need to save \`sysBank\` first. During insertion, the \`id\` will be written back, then when \`savable(sysUser)\`, the aggregate root association property will be written back.

### Example Many-to-One
\`\`\`java

public class SysBankCard {
    @Column(primaryKey = true)
    private String id;
    private String uid;
    /**
     * Bank card number
     */
    private String code;

    /**
     * Bank to which it belongs
     */
    @Navigate(value = RelationTypeEnum.ManyToOne, selfProperty = {"bankId"}, targetProperty = {"id"})
    private SysBank bank;

    /**
     * User to which it belongs
     */
    @Navigate(value = RelationTypeEnum.ManyToOne, selfProperty = {"uid"}, targetProperty = {"id"})
    private SysUser user;
}

\`\`\`

\`SysBankCard\` and \`SysBank\` are many-to-one, \`SysBankCard\` and \`SysUser\` are also many-to-one. When constructing \`SysBankCard\`, since both \`SysBank\` and \`SysUser\` are aggregate roots of \`SysBankCard\`, savable(new SysBankCard()) will only get the association relationship values of the aggregate roots and assign them to the current \`SysBankCard\`, even if \`SysBankCard\` has corresponding \`SysBank\` or \`SysUser\` added.
During \`savable(new SysBankCard())\`, only \`SysBankCard\` itself will be saved.
\`\`\`java

        SysBankCard sysBankCard = new SysBankCard();
        sysBankCard.setCode("....");
        SysUser sysUser = easyEntityQuery.queryable(SysUser.class)
                .whereById("123").singleNotNull();
        sysBankCard.setUser(sysUser);

        //Save after opening transaction
        //This save will only add sysBankCard and will assign sysUser's id to sysBankCard's uid field
        easyEntityQuery.savable(sysBankCard).executeCommand();
\`\`\`

### Many-to-Many
Many-to-many is a relatively special association relationship.

First, users need to understand whether this many-to-many mapping table has business fields, that is, business fields other than association relationships, primary keys, and creation time and other general fields.

Users need to explicitly tell the framework whether to handle the mapping table during many-to-many save. If there are extra business fields, automatic save is not possible and users need to handle manually, or add an additional one-to-many relationship between the current table and the mapping table.
\`\`\`java

@Data
@EntityProxy
@Table("m8_user")
@FieldNameConstants
public class M8User implements ProxyEntityAvailable<M8User , M8UserProxy> {
    @Column(primaryKey = true)
    private String id;
    private String name;
    private Integer age;
    private LocalDateTime createTime;

    @Navigate(value = RelationTypeEnum.ManyToMany,
            selfProperty = {M8User.Fields.id},
            selfMappingProperty = {M8UserRole.Fields.userId},
            mappingClass = M8UserRole.class,
            targetProperty = {M8Role.Fields.id},
            targetMappingProperty = {M8UserRole.Fields.roleId}, cascade = CascadeTypeEnum.DELETE)//Set as value object then it will automatically handle the mapping table
    private List<M8Role> roles;
}



        M8User m8User = easyEntityQuery.queryable(M8User.class)
                .include(m -> m.roles())
                .singleNotNull();
        List<M8Role> list = easyEntityQuery.queryable(M8Role.class)
                .where(m -> {
                })
                .toList();
        m8User.getRoles().remove(0);
        m8User.getRoles().addAll(list);


        try(Transaction transaction = easyEntityQuery.beginTransaction()){
            easyEntityQuery.savable(m8User).executeCommand();//Automatically remove one UserRole and add the same number of UserRole as the list
            transaction.commit();
        }
\`\`\`

If there are business fields, please change cascade to \`cascade = CascadeTypeEnum.NO_ACTION\`, then separately create navigation for \`User\` and \`UserRole\`

\`\`\`java

@Data
@EntityProxy
@Table("m8_user")
@FieldNameConstants
public class M8User implements ProxyEntityAvailable<M8User, M8UserProxy> {
    @Column(primaryKey = true)
    private String id;
    private String name;
    private Integer age;
    private LocalDateTime createTime;

    @Navigate(value = RelationTypeEnum.ManyToMany,
            selfProperty = {M8User.Fields.id},
            selfMappingProperty = {M8UserRole.Fields.userId},
            mappingClass = M8UserRole.class,
            targetProperty = {M8Role.Fields.id},
            targetMappingProperty = {M8UserRole.Fields.roleId}, cascade = CascadeTypeEnum.NO_ACTION)
    private List<M8Role> roles;

    /**
     * Add a navigation input because M8UserRole has business fields
     **/
    @Navigate(value = RelationTypeEnum.OneToMany, selfProperty = {M8User.Fields.id}, targetProperty = {M8UserRole.Fields.userId})
    private List<M8UserRole> m8UserRoleList;
}


M8User user=new M8User()
M8UserRole userRole=new M8UserRole() 
userRole.setBusiness("XXXXX");
user.setM8UserRoleList(Arrays.asList(userRole))


try(Transaction transaction = easyEntityQuery.beginTransaction()){
    easyEntityQuery.savable(user).executeCommand();
    transaction.commit();
}
\`\`\` `)])}const g=e(h,[["render",k]]),y=JSON.parse('{"path":"/en/savable/","title":"Aggregate Root Save","lang":"en-US","frontmatter":{"title":"Aggregate Root Save","description":"Aggregate Root Save eq implemented aggregate root save mode after 3.1.24, which can track changes to aggregate root objects and differential changes to corresponding value objec...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Aggregate Root Save\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2025-10-29T00:34:40.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"xuejmnet\\",\\"url\\":\\"https://github.com/xuejmnet\\"}]}"],["meta",{"property":"og:url","content":"https://github.com/dromara/easy-query/easy-query-doc/en/savable/"}],["meta",{"property":"og:site_name","content":"Documentation"}],["meta",{"property":"og:title","content":"Aggregate Root Save"}],["meta",{"property":"og:description","content":"Aggregate Root Save eq implemented aggregate root save mode after 3.1.24, which can track changes to aggregate root objects and differential changes to corresponding value objec..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"en-US"}],["meta",{"property":"og:locale:alternate","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-10-29T00:34:40.000Z"}],["meta",{"property":"article:modified_time","content":"2025-10-29T00:34:40.000Z"}],["link",{"rel":"alternate","hreflang":"zh-cn","href":"https://github.com/dromara/easy-query/easy-query-doc/savable/"}]]},"git":{"createdTime":1761500387000,"updatedTime":1761698080000,"contributors":[{"name":"只是我","username":"","email":"alice@example.com","commits":1},{"name":"芥子-李显亮","username":"","email":"lixianliang@microbigdata.com.cn","commits":1},{"name":"xuejiaming","username":"xuejiaming","email":"326308290@qq.com","commits":1,"url":"https://github.com/xuejiaming"}]},"readingTime":{"minutes":4.76,"words":1429},"filePathRelative":"en/savable/README.md","autoDesc":true}');export{g as comp,y as data};
